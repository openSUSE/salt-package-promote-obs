#!/usr/bin/env groovy

// Configure the build properties
properties([
    buildDiscarder(logRotator(numToKeepStr: '20')),
    disableConcurrentBuilds(),
])

pipeline {

    parameters {
        string(defaultValue: '', description: 'SUSE Manager maintenance update version that this Salt Bundle update is released with, e.g. 4.2.6', name: 'mu_version')
    }

    agent { label 'manager-jenkins-node' }

    stages {
        stage('Initial Checks') {
            steps {
                echo "Check that 'openSUSE/MU/${mu_version}' branch exists at https://github.com/openSUSE/salt"
                sh "curl -I --fail https://codeload.github.com/openSUSE/salt/tar.gz/openSUSE/MU/${mu_version}"

                echo "Check that 'MU/${mu_version}' branch exists at https://github.com/openSUSE/salt-packaging"
                sh "curl -I --fail https://codeload.github.com/openSUSE/salt-packaging/tar.gz/MU/${mu_version}"
            }
        }

        stage('Promote Salt Bundle dependency packages and project configurations for Salt Bundle subprojects') {
            steps {
                sh 'python3 promote_packages.py systemsmanagement:saltstack:bundle:testing systemsmanagement:saltstack:bundle'
            }
        }
    }
}
